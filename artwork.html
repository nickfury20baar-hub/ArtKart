<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ArtKart — Artwork</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WM217K82H4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-WM217K82H4');
</script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; }
    body { background:#f5f6fa; min-height:100vh; color:#222; padding-bottom:90px; }

    header {
      background:#fff; padding:14px 16px; display:flex; align-items:center; gap:12px;
      box-shadow:0 2px 10px rgba(0,0,0,0.06); position:sticky; top:0; z-index:100;
    }
    .logo { width:38px; height:38px; border-radius:10px; background:linear-gradient(135deg,#6c63ff,#9f9cff); }
    header h1 { font-size:21px; font-weight:600; color:#2d2d2d; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .container { padding:16px; max-width:720px; margin:0 auto; }

    .hero-img {
      width:100%; border-radius:16px; margin-bottom:20px;
      box-shadow:0 8px 24px rgba(0,0,0,0.12); object-fit:cover; background:#e8e8e8;
    }

    .title-row {
      display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;
    }
    .art-title { font-size:22px; font-weight:600; line-height:1.3; }
    .price-tag {
      font-size:18px; font-weight:600; color:#6c63ff; background:#f0f1ff;
      padding:6px 14px; border-radius:12px;
    }

    .artist { font-size:15px; color:#555; margin-bottom:16px; }

    .meta-row {
      display:flex; justify-content:space-between; align-items:center; margin:16px 0;
      font-size:14px; color:#444;
    }
    .like-section {
      display:flex; align-items:center; gap:8px; cursor:pointer;
    }
    .like-section.liked .material-symbols-outlined {
      font-variation-settings: 'FILL' 1;
      color:#ff4757;
    }
    .category-tag {
      background:#e0f0ff; color:#0066cc; padding:6px 12px; border-radius:12px;
      font-size:13px;
    }

    .description {
      background:#fff; border-radius:14px; padding:16px;
      box-shadow:0 4px 16px rgba(0,0,0,0.06); margin:24px 0;
      line-height:1.6; color:#444;
    }

    .action-bar {
      position:fixed; bottom:68px; left:0; right:0; background:#fff;
      padding:12px 16px; display:flex; gap:12px; box-shadow:0 -2px 10px rgba(0,0,0,0.1);
      z-index:90;
    }
    .btn {
      flex:1; padding:14px; border-radius:12px; font-size:15px; font-weight:500;
      cursor:pointer; border:none; transition:all 0.2s;
    }
    .btn-primary { background:#6c63ff; color:white; }
    .btn-primary:hover { background:#5a52e0; }
    .btn-outline { background:white; color:#6c63ff; border:1.5px solid #6c63ff; }
    .btn-outline:hover { background:#f0f1ff; }

    .bottom-nav {
      position:fixed; bottom:0; left:0; width:100%; height:68px; background:#fff;
      display:flex; justify-content:space-around; align-items:center;
      box-shadow:0 -3px 12px rgba(0,0,0,0.09); z-index:100;
    }
    .nav-item { flex:1; text-align:center; font-size:11px; color:#666; cursor:pointer; }
    .nav-item.active { color:#6c63ff; font-weight:600; }
    .nav-item .material-symbols-outlined { font-size:26px; margin-bottom:4px; display:block; }
    .nav-item.active .material-symbols-outlined { color:#6c63ff; }

    .loading-full { text-align:center; padding:120px 24px; color:#777; font-size:16px; }
    .error-full { text-align:center; padding:100px 24px; color:#ff4757; font-size:16px; }
  </style>
</head>
<body>

  <header>
    <button class="back-btn" onclick="history.back()">
      <span class="material-symbols-outlined">arrow_back</span>
    </button>
    <h1 id="pageTitle">Artwork</h1>
  </header>

  <div class="loading-full" id="loading">Loading artwork details...</div>
  <div class="error-full" id="error" style="display:none;"></div>

  <div class="container" id="content" style="display:none;">
    <div class="title-row">
      <div class="art-title" id="title">Loading...</div>
      <div class="price-tag" id="price">₹0</div>
    </div>

    <div class="artist" id="artist">by Unknown</div>

    <img id="heroImg" class="hero-img" src="" alt="Artwork">

    <div class="meta-row">
      <div class="like-section" id="likeSection">
        <span class="material-symbols-outlined" id="likeIcon">favorite</span>
        <span id="likeCount">0 Likes</span>
      </div>
          <div class="like-section" id="shareBtn">
      <span class="material-symbols-outlined">share</span>
      <span>Share</span>
    </div>
    <span class="material-symbols-outlined" id="openComments" style="cursor:pointer;">
      comment
    </span>
      <span class="category-tag" id="category">—</span>
      
    </div>


    <div class="description" id="description">
      No description available.
    </div>
  </div>

  <div class="action-bar" id="actionBar" style="display:none;">
    <button class="btn btn-outline" id="saveBtn">Save</button>
    <button  class="btn btn-primary" id="buyBtn">Buy Now</button>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item" data-page="home">
      <span class="material-symbols-outlined">home</span> Home
    </div>
    <div class="nav-item" data-page="explore">
      <span class="material-symbols-outlined">explore</span> Explore
    </div>
    <div class="nav-item active" data-page="profile">
      <span class="material-symbols-outlined">person</span> Profile
    </div>
  </nav>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ================= FIREBASE INIT ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCZ-QeZrs6qJlDk4ZMs9LP2iQ4wjJ2vcF8",
  authDomain: "artkart-69692.firebaseapp.com",
  projectId: "artkart-69692",
  storageBucket: "artkart-69692.appspot.com",
  messagingSenderId: "1067935304156",
  appId: "1:1067935304156:web:d8c50769ecb9797f8d6719"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

/* ================= GET ART ID ================= */
const artId = new URLSearchParams(window.location.search).get("id");
if (!artId) {
  loading.style.display = "none";
  error.textContent = "No artwork ID found";
  error.style.display = "block";
  throw new Error("No artId");
}

/* ================= GLOBAL STATE ================= */
let currentUserId = null;
let artworkData = null;
let artArtistId = null;
let isLiked = false;
let isSaved = false;
let saveDocId = null;
let commentVisibility = "public";

/* ================= AUTH ================= */
auth.onAuthStateChanged(async user => {
  currentUserId = user ? user.uid : null;

  try {
    const artRef = db.collection("arts").doc(artId);
    const artSnap = await artRef.get();

    if (!artSnap.exists) throw new Error("Artwork not found");

    artworkData = artSnap.data();
    artArtistId = artworkData.artistId;

    await countUniqueView();
    renderArtwork();
    setupLike();
    setupSave();
    setupShare();
    setupComments();

  } catch (err) {
    loading.style.display = "none";
    error.textContent = err.message;
    error.style.display = "block";
  }
});

/* ================= UNIQUE VIEW ================= */
async function countUniqueView() {
  if (!currentUserId) return;

  const viewId = `${artId}_${currentUserId}`;
  const viewRef = db.collection("artViews").doc(viewId);
  const artRef = db.collection("arts").doc(artId);

  const snap = await viewRef.get();
  if (snap.exists) return;

  await viewRef.set({
    artId,
    userId: currentUserId,
    artistId: artArtistId,
    viewedAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  await artRef.update({
    views: firebase.firestore.FieldValue.increment(1)
  });
}

/* ================= RENDER ART ================= */
function renderArtwork() {
  pageTitle.textContent = artworkData.title || "Untitled";
  heroImg.src = artworkData.imageUrl || "https://via.placeholder.com/720x540";
  title.textContent = artworkData.title || "Untitled";
  artist.textContent = `by ${artworkData.artistName || "Unknown"}`;
  price.textContent = `₹${(artworkData.price || 0).toLocaleString()}`;
  category.textContent = artworkData.category || "—";
  likeCount.textContent = `${artworkData.likeCount || 0} Likes`;
  description.textContent = artworkData.description || "No description";

  loading.style.display = "none";
  content.style.display = "block";
  actionBar.style.display = "flex";
}

/* ================= SHARE ================= */
function setupShare() {
  shareBtn.onclick = async () => {
    if (!currentUserId) return alert("Login required");

    const shareId = `${artId}_${currentUserId}`;
    const shareRef = db.collection("artShares").doc(shareId);
    const artRef = db.collection("arts").doc(artId);

    const snap = await shareRef.get();
    if (!snap.exists) {
      await shareRef.set({
        artId,
        userId: currentUserId,
        artistId: artArtistId,
        sharedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      await artRef.update({
        shareCount: firebase.firestore.FieldValue.increment(1)
      });
    }

    if (navigator.share) {
      await navigator.share({
        title: artworkData.title,
        url: location.href
      });
    } else {
      await navigator.clipboard.writeText(location.href);
      alert("Link copied");
    }
  };
}

/* ================= LIKE ================= */
async function setupLike() {
  if (!currentUserId) return;

  const snap = await db.collection("likes")
    .where("userId", "==", currentUserId)
    .where("artId", "==", artId)
    .limit(1)
    .get();

  isLiked = !snap.empty;
  if (isLiked) {
    likeSection.classList.add("liked");
    likeIcon.style.fontVariationSettings = "'FILL' 1";
  }

  likeSection.onclick = async () => {
    const artRef = db.collection("arts").doc(artId);
    let count = Number(artworkData.likeCount || 0);

    if (isLiked) {
      snap.forEach(d => d.ref.delete());
      count--;
    } else {
      await db.collection("likes").add({
        userId: currentUserId,
        artId,
        artistId: artArtistId,
        likedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      count++;
    }

    await artRef.update({ likeCount: count });
    artworkData.likeCount = count;
    likeCount.textContent = `${count} Likes`;
    isLiked = !isLiked;
    likeSection.classList.toggle("liked");
    likeIcon.style.fontVariationSettings = isLiked ? "'FILL' 1" : "";
  };
}

/* ================= SAVE ================= */
async function setupSave() {
  if (!currentUserId) return saveBtn.onclick = () => alert("Login required");

  const snap = await db.collection("saves")
    .where("userId", "==", currentUserId)
    .where("artId", "==", artId)
    .limit(1)
    .get();

  if (!snap.empty) {
    isSaved = true;
    saveDocId = snap.docs[0].id;
    saveBtn.textContent = "Saved";
  }

  saveBtn.onclick = async () => {
    if (isSaved) {
      await db.collection("saves").doc(saveDocId).delete();
      isSaved = false;
      saveDocId = null;
      saveBtn.textContent = "Save";
      return;
    }

    const doc = await db.collection("saves").add({
      artId,
      userId: currentUserId,
      artistId: artArtistId,
      savedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    isSaved = true;
    saveDocId = doc.id;
    saveBtn.textContent = "Saved";
  };
}

/* ================= COMMENTS ================= */
function setupComments() {

  openComments.onclick = () => {
    commentSheet.style.display = "block";
    loadComments();
  };

  closeComments.onclick = () => {
    commentSheet.style.display = "none";
  };

  commentFilterBtn.onclick = () => {
    commentFilter.style.display =
      commentFilter.style.display === "block" ? "none" : "block";
  };

  document.querySelectorAll(".filterBtn").forEach(btn => {
    btn.onclick = () => {
      commentVisibility = btn.dataset.type;
      commentFilter.style.display = "none";
      loadComments();
    };
  });

  sendComment.onclick = async () => {
    if (!currentUserId) return alert("Login required");
    if (!commentText.value.trim()) return;

    await db.collection("comments").add({
      artId,
      userId: currentUserId,
      artistId: artArtistId,
      userName: auth.currentUser.displayName || "User",
      userPhoto: auth.currentUser.photoURL,
      text: commentText.value.trim(),
      visibility: commentVisibility,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    commentText.value = "";
    loadComments();
  };
}

async function loadComments() {
  commentList.innerHTML = "Loading...";

  const snap = await db.collection("comments")
    .where("artId", "==", artId)
    .orderBy("createdAt", "desc")
    .get();

  commentList.innerHTML = "";

  snap.forEach(d => {
    const c = d.data();

    if (
      c.visibility === "artist" &&
      currentUserId !== c.artistId &&
      currentUserId !== c.userId
    ) return;

    if (commentVisibility !== c.visibility) return;

    const div = document.createElement("div");
    div.style.display = "flex";
    div.style.gap = "10px";

    div.innerHTML = `
      <img src="${c.userPhoto || 'https://via.placeholder.com/40'}"
           style="width:40px;height:40px;border-radius:50%">
      <div>
        <b>${c.userName}</b>
        <div>${c.text}</div>
      </div>
    `;
    commentList.appendChild(div);
  });
}

/* ================= BUY ================= 
buyBtn.onclick = () => {
  location.href = `order-details.html?id=${artId}`;
};
*/

buyBtn.onclick = () => {
  alert("Buy feature coming soon... Check back after few days.");
};
</script>
  <!-- COMMENTS OVERLAY -->
<!-- COMMENTS BOTTOM SHEET -->
<div id="commentSheet" style="display:none; position:fixed; bottom:0; left:0; width:100%; height:80%; background:#fff; border-radius:18px 18px 0 0; z-index:200; box-shadow:0 -4px 20px rgba(0,0,0,.15);">

  <!-- HEADER -->
  <div style="display:flex; align-items:center; padding:14px 16px; border-bottom:1px solid #eee;">
    <span id="commentFilterBtn" class="material-symbols-outlined" style="cursor:pointer;">tune</span>
    <div style="flex:1; text-align:center; font-weight:600;">Comments</div>
    <span id="closeComments" class="material-symbols-outlined" style="cursor:pointer;">close</span>
  </div>

  <!-- FILTER -->
  <div id="commentFilter" style="display:none; padding:10px; border-bottom:1px solid #eee;">
    <button class="filterBtn" data-type="public">Public</button>
    <button class="filterBtn" data-type="artist">Artist only</button>
  </div>

  <!-- COMMENT LIST -->
  <div id="commentList" style="padding:14px; overflow-y:auto; height:calc(100% - 140px);"></div>

  <!-- INPUT -->
  <div style="display:flex; gap:8px; padding:12px; border-top:1px solid #eee;">
    <input id="commentText" placeholder="Add a comment…" style="flex:1; padding:10px; border-radius:20px; border:1px solid #ccc;">
    <button id="sendComment">Send</button>
  </div>

</div>

<!-- COMMENT OPEN ICON (ADD THIS NEAR LIKE ICON IN META ROW IF NEEDED) -->

</body>
</html>
