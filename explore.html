<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ArtKart — Explore</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WM217K82H4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-WM217K82H4');
</script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; }
    body { background:#f5f6fa; padding-bottom:80px; }

    header {
      background:#ffffff; padding:14px 16px; display:flex; align-items:center; gap:12px;
      box-shadow:0 2px 10px rgba(0,0,0,0.06); position:sticky; top:0; z-index:100;
    }
    .logo { width:38px; height:38px; border-radius:10px; background:linear-gradient(135deg,#6c63ff,#9f9cff); }
    header h1 { font-size:21px; font-weight:600; color:#2d2d2d; }

    .search-bar { margin:16px 16px 12px; position:relative; }
    .search-bar input {
      width:100%; padding:12px 16px 12px 48px; border:none; border-radius:12px;
      background:#ffffff; font-size:15px; box-shadow:0 4px 12px rgba(0,0,0,0.05);
      outline:none;
    }
    .search-icon { position:absolute; left:16px; top:50%; transform:translateY(-50%); color:#777; font-size:22px; }

    .categories { display:flex; overflow-x:auto; padding:0 16px 16px; gap:12px; scrollbar-width:none; }
    .categories::-webkit-scrollbar { display:none; }
    .chip {
      padding:10px 18px; background:#f0f1ff; border-radius:24px;
      font-size:14px; font-weight:500; color:#444; white-space:nowrap;
      transition:all 0.2s; cursor:pointer;
    }
    .chip.active, .chip:hover { background:#6c63ff; color:white; }

    .items {
      display:grid; grid-template-columns:repeat(2,1fr); gap:14px; padding:0 16px;
    }
    .item-card {
      background:#ffffff; border-radius:14px; overflow:hidden;
      box-shadow:0 6px 18px rgba(0,0,0,0.06); transition:transform 0.15s;
      text-decoration:none; color:inherit; display:block;
    }
    .item-card:hover { transform:translateY(-4px); }
    .item-img { height:140px; background:#e0e0e0; object-fit:cover; width:100%; }
    .item-content { padding:12px; }
    .item-title { font-size:14px; font-weight:500; margin-bottom:4px; }
    .item-artist { font-size:12px; color:#777; margin-bottom:6px; }
    .item-meta { display:flex; justify-content:space-between; align-items:center; font-size:13px; }
    .item-price { color:#6c63ff; font-weight:500; }
    .like-btn {
      background:none; border:none; color:#ff4757; font-size:24px; cursor:pointer;
      padding:4px; transition:transform 0.2s; display:flex; align-items:center; gap:4px;
    }
    .like-btn.liked .material-symbols-outlined { font-variation-settings:'FILL' 1; }
    .like-btn:active { transform:scale(1.3); }

    .loading { text-align:center; padding:60px 20px; color:#777; font-size:15px; }
    .empty { text-align:center; padding:80px 24px; color:#777; }
    .empty-icon { font-size:64px; color:#d0d0d0; margin-bottom:16px; }

    .bottom-nav {
      position:fixed; bottom:0; left:0; width:100%; height:68px; background:#ffffff;
      display:flex; justify-content:space-around; align-items:center;
      box-shadow:0 -3px 12px rgba(0,0,0,0.09); z-index:100;
    }
    .nav-item { flex:1; text-align:center; font-size:11px; color:#666; cursor:pointer; }
    .nav-item.active { color:#6c63ff; font-weight:600; }
    .nav-item .material-symbols-outlined { font-size:26px; margin-bottom:4px; display:block; }
    .nav-item.active .material-symbols-outlined { color:#6c63ff; }

    .sentinel { height:1px; }
  </style>
</head>
<body>

  <header>
    <div class="logo"></div>
    <h1>ArtKart</h1>
  </header>

  <div class="search-bar">
    <span class="material-symbols-outlined search-icon">search</span>
    <input type="text" id="searchInput" placeholder="Search artworks, artists..." />
  </div>

  <div class="categories">
    <div class="chip active" data-category="">All</div>
    <div class="chip" data-category="Painting">Painting</div>
    <div class="chip" data-category="Digital Art">Digital Art</div>
    <div class="chip" data-category="Sketch">Sketch</div>
    <div class="chip" data-category="Abstract">Abstract</div>
    <div class="chip" data-category="Nature">Nature</div>
    <div class="chip" data-category="Poster">Poster</div>
    <div class="chip" data-category="3D">3D</div>
  </div>

  <div class="loading" id="loading">Loading artworks...</div>
  <div class="items" id="itemsGrid" style="display:none;"></div>

  <div class="sentinel" id="sentinel"></div>

  <div class="empty" id="emptyState" style="display:none;">
    <span class="material-symbols-outlined empty-icon">palette</span>
    <h3>No artworks found</h3>
    <p>Try different keywords or upload new art!</p>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item" data-page="home">
      <span class="material-symbols-outlined">home</span> Home
    </div>
    <div class="nav-item active" data-page="explore">
      <span class="material-symbols-outlined">explore</span> Explore
    </div>
    <div class="nav-item" data-page="profile">
      <span class="material-symbols-outlined">person</span> Profile
    </div>
  </nav>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCZ-QeZrs6qJlDk4ZMs9LP2iQ4wjJ2vcF8",
      authDomain: "artkart-69692.firebaseapp.com",
      projectId: "artkart-69692",
      storageBucket: "artkart-69692.appspot.com",
      messagingSenderId: "1067935304156",
      appId: "1:1067935304156:web:d8c50769ecb9797f8d6719"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // State
    const PAGE_SIZE = 12;
    let lastDoc = null;
    let isLoading = false;
    let hasMore = true;
    let currentUserId = null;
    let searchTerm = "";
    let selectedCategory = "";

    const grid = document.getElementById("itemsGrid");
    const loading = document.getElementById("loading");
    const empty = document.getElementById("emptyState");
    const sentinel = document.getElementById("sentinel");
    const searchInput = document.getElementById("searchInput");
    const chips = document.querySelectorAll(".chip");

    // Auth change → full reset
    auth.onAuthStateChanged(user => {
      currentUserId = user ? user.uid : null;
      console.log("User changed:", currentUserId ? "Logged in" : "Not logged in");
      resetAndReload();
    });

    // Search + category
    searchInput.addEventListener("input", debounce(() => {
      searchTerm = searchInput.value.trim().toLowerCase();
      resetAndReload();
    }, 400));

    chips.forEach(chip => {
      chip.addEventListener("click", () => {
        chips.forEach(c => c.classList.remove("active"));
        chip.classList.add("active");
        selectedCategory = chip.dataset.category || "";
        resetAndReload();
      });
    });

    function resetAndReload() {
      grid.innerHTML = "";
      lastDoc = null;
      hasMore = true;
      loading.style.display = "block";
      empty.style.display = "none";
      loadMoreArtworks();
    }

    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    }

    // Load artworks
    async function loadMoreArtworks() {
      if (isLoading) return;
      isLoading = true;

      try {
        let query = db.collection("arts")
          .orderBy("createdAt", "desc")
          .limit(PAGE_SIZE);

        if (lastDoc) query = query.startAfter(lastDoc);

        const snap = await query.get();

        loading.style.display = "none";

        if (snap.empty) {
          hasMore = false;
          if (grid.children.length === 0) {
            grid.style.display = "none";
            empty.style.display = "block";
          }
          return;
        }

        grid.style.display = "grid";

        snap.forEach(doc => {
          const art = doc.data();
          const artId = doc.id;

          // Debug log
          console.log("Artwork:", { id: artId, title: art.title, imageUrl: art.imageUrl });

          // Client-side filter
          const title = (art.title || "").toLowerCase();
          const artist = (art.artistName || "").toLowerCase();
          const cat = (art.category || "").toLowerCase();

          if (searchTerm && !title.includes(searchTerm) && !artist.includes(searchTerm)) return;
          if (selectedCategory && cat !== selectedCategory.toLowerCase()) return;

          // Like status
          const isLiked = false; // Placeholder - implement if needed

          const card = document.createElement("a");
          card.href = `artwork.html?id=${artId}`;
          card.className = "item-card";
          card.innerHTML = `
            <img class="item-img" src="${art.imageUrl || 'https://via.placeholder.com/300?text=Image'}" alt="${art.title || 'Artwork'}">
            <div class="item-content">
              <div class="item-title">${art.title || 'Untitled'}</div>
              <div class="item-artist">by ${art.artistName || 'Unknown'}</div>
              <div class="item-meta">
                <span class="item-price">₹${(art.price || 0).toLocaleString()}</span>
                <button class="like-btn">
                  <span class="material-symbols-outlined">favorite</span>
                  <span>${art.likeCount || 0}</span>
                </button>
              </div>
            </div>
          `;

          grid.appendChild(card);
        });

        lastDoc = snap.docs[snap.docs.length - 1];
      } catch (err) {
        console.error("Load error:", err);
        loading.innerHTML = "Failed to load artworks.";
      } finally {
        isLoading = false;
      }
    }

    // Initial load
    loadMoreArtworks();

    // Pull-to-refresh
    let touchStartY = 0;
    let pullDistance = 0;
    const pullThreshold = 120;

    window.addEventListener("touchstart", e => {
      if (window.scrollY === 0) touchStartY = e.touches[0].clientY;
    }, { passive: true });

    window.addEventListener("touchend", () => {
      if (pullDistance >= pullThreshold) location.reload();
      pullDistance = 0;
      touchStartY = 0;
    }, { passive: true });

    // Bottom nav
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const page = item.getAttribute('data-page');
        if (page === 'home') location.href = 'home.html';
        if (page === 'profile') location.href = 'profile.html';
      });
    });
  </script>
</body>
</html>