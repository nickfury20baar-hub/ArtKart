<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ArtKart — My Orders</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WM217K82H4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-WM217K82H4');
</script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; }
    body { background:#f5f6fa; min-height:100vh; color:#222; padding-bottom:90px; }

    #pullIndicator {
      position: fixed; top: -60px; left:0; right:0; height:60px;
      display:flex; align-items:center; justify-content:center;
      background:#6c63ff; color:white; font-weight:500;
      transition:top 0.3s ease; z-index:200;
    }
    #pullIndicator.active { top:0; }

    header {
      background:#fff; padding:12px 16px; display:flex; align-items:center; gap:16px;
      box-shadow:0 2px 10px rgba(0,0,0,0.06); position:sticky; top:0; z-index:100;
    }
    .back-btn { background:none; border:none; color:#6c63ff; font-size:28px; cursor:pointer; }
    h1 { font-size:20px; font-weight:600; flex:1; }

    .container { padding:16px; }
    .section-title { font-size:18px; font-weight:600; margin:8px 0 16px 4px; color:#333; }

    .orders-list { display:flex; flex-direction:column; gap:16px; }

    .order-card {
      background:#ffffff; border-radius:14px; overflow:hidden;
      box-shadow:0 4px 16px rgba(0,0,0,0.08);
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }

    .order-header {
      padding:14px 16px; background:#f8f9ff; border-bottom:1px solid #eee;
      display:flex; justify-content:space-between; align-items:center;
    }
    .order-id { font-size:14px; font-weight:500; color:#555; }
    .order-status {
      padding:6px 12px; border-radius:20px; font-size:12px; font-weight:500;
    }
    .status-pending  { background:#fff3cd; color:#856404; }
    .status-processing { background:#d1ecf1; color:#0c5460; }
    .status-shipped   { background:#d4edda; color:#155724; }
    .status-delivered { background:#c3e6cb; color:#155724; font-weight:600; }
    .status-cancelled { background:#f8d7da; color:#721c24; }

    .order-body { padding:16px; }
    .order-item {
      display:flex; gap:12px; margin-bottom:12px; padding-bottom:12px;
      border-bottom:1px solid #f0f0f0;
    }
    .order-item:last-child { border-bottom:none; margin-bottom:0; padding-bottom:0; }

    .item-thumb {
      width:64px; height:64px; border-radius:8px; object-fit:cover;
      background:#e8e8e8; flex-shrink:0;
    }
    .item-info { flex:1; }
    .item-title { font-size:14px; font-weight:500; margin-bottom:4px; }
    .item-meta { font-size:12px; color:#666; }

    .order-summary {
      padding:12px 16px; background:#f8f9ff; font-size:14px;
    }
    .summary-row {
      display:flex; justify-content:space-between; margin:6px 0;
    }
    .total-row {
      font-weight:600; font-size:15px; border-top:1px solid #ddd;
      padding-top:8px; margin-top:8px;
    }

    .loading, .empty-state { text-align:center; padding:80px 24px; color:#777; }
    .empty-icon { font-size:64px; color:#d0d0d0; margin-bottom:16px; }

    .bottom-nav {
      position:fixed; bottom:0; left:0; width:100%; height:68px; background:#fff;
      display:flex; justify-content:space-around; align-items:center;
      box-shadow:0 -3px 12px rgba(0,0,0,0.09); z-index:100;
    }
    .nav-item { flex:1; text-align:center; font-size:11px; color:#666; cursor:pointer; }
    .nav-item.active { color:#6c63ff; font-weight:600; }
    .nav-item .material-symbols-outlined { font-size:26px; margin-bottom:4px; display:block; }
    .nav-item.active .material-symbols-outlined { color:#6c63ff; }

    .sentinel { height:1px; }
  </style>
</head>
<body>

  <div id="pullIndicator">Refreshing...</div>

  <header>
    <button class="back-btn" onclick="history.back()">
      <span class="material-symbols-outlined">arrow_back</span>
    </button>
    <h1>My Orders</h1>
  </header>

  <div class="container">
    <div class="section-title">Order History</div>

    <div class="loading" id="loading">Loading your orders...</div>

    <div class="orders-list" id="ordersList" style="display:none;"></div>

    <div class="sentinel" id="sentinel"></div>

    <div class="empty-state" id="emptyState" style="display:none;">
      <span class="material-symbols-outlined empty-icon">shopping_bag</span>
      <h3>No orders yet</h3>
      <p>When you purchase artwork, your orders will appear here.</p>
    </div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item" data-page="home">
      <span class="material-symbols-outlined">home</span> Home
    </div>
    <div class="nav-item" data-page="explore">
      <span class="material-symbols-outlined">explore</span> Explore
    </div>
    <div class="nav-item active" data-page="profile">
      <span class="material-symbols-outlined">person</span> Profile
    </div>
  </nav>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCZ-QeZrs6qJlDk4ZMs9LP2iQ4wjJ2vcF8",
      authDomain: "artkart-69692.firebaseapp.com",
      projectId: "artkart-69692",
      storageBucket: "artkart-69692.appspot.com",
      messagingSenderId: "1067935304156",
      appId: "1:1067935304156:web:d8c50769ecb9797f8d6719"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Pull-to-refresh (same as previous pages)
    let touchStartY = 0;
    let pullDistance = 0;
    const pullThreshold = 120;
    const pullEl = document.getElementById("pullIndicator");

    window.addEventListener("touchstart", e => {
      if (window.scrollY === 0) touchStartY = e.touches[0].clientY;
    }, { passive: true });

    window.addEventListener("touchmove", e => {
      if (touchStartY === 0 || window.scrollY > 0) return;
      pullDistance = e.touches[0].clientY - touchStartY;
      if (pullDistance > 0) {
        pullEl.style.top = `${Math.min(pullDistance / 2 - 60, 0)}px`;
      }
    }, { passive: true });

    window.addEventListener("touchend", () => {
      if (pullDistance >= pullThreshold) {
        pullEl.classList.add("active");
        setTimeout(() => location.reload(), 800);
      }
      pullDistance = 0;
      touchStartY = 0;
      pullEl.style.top = "-60px";
      pullEl.classList.remove("active");
    }, { passive: true });

    // ────────────────────────────────────────────────
    // Infinite scroll + load orders
    // ────────────────────────────────────────────────
    const PAGE_SIZE = 10; // fewer per page because orders are more "heavy"
    let lastDoc = null;
    let isLoading = false;
    let hasMore = true;

    const list = document.getElementById("ordersList");
    const loading = document.getElementById("loading");
    const empty = document.getElementById("emptyState");
    const sentinel = document.getElementById("sentinel");

    const observer = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting && !isLoading && hasMore) {
        loadMoreOrders();
      }
    }, { rootMargin: "200px" });

    observer.observe(sentinel);

    function getStatusClass(status) {
      const s = (status || "pending").toLowerCase();
      if (s.includes("deliver")) return "status-delivered";
      if (s.includes("ship"))    return "status-shipped";
      if (s.includes("process"))  return "status-processing";
      if (s.includes("cancel"))   return "status-cancelled";
      return "status-pending";
    }

    async function loadMoreOrders() {
      if (isLoading) return;
      isLoading = true;

      try {
        let query = db.collection("orders")
          .where("buyerId", "==", auth.currentUser.uid)
          .orderBy("createdAt", "desc")
          .limit(PAGE_SIZE);

        if (lastDoc) query = query.startAfter(lastDoc);

        const snap = await query.get();

        if (snap.empty) {
          hasMore = false;
          if (list.children.length === 0) {
            list.style.display = "none";
            empty.style.display = "block";
          }
          return;
        }

        loading.style.display = "none";
        list.style.display = "flex";

        snap.forEach(doc => {
          const data = doc.data();
          const orderDate = data.createdAt
            ? new Date(data.createdAt.toDate()).toLocaleDateString("en-IN", {
                day: "numeric", month: "short", year: "numeric"
              })
            : "—";

          const itemsHtml = (data.items || []).map(item => `
            <div class="order-item">
              <img class="item-thumb" src="\( {item.imageUrl || 'https://via.placeholder.com/64'}" alt=" \){item.title}">
              <div class="item-info">
                <div class="item-title">${item.title || 'Item'}</div>
                <div class="item-meta">
                  Qty: \( {item.quantity || 1} • ₹ \){(item.price || 0).toLocaleString()}
                </div>
              </div>
            </div>
          `).join('');

          const card = document.createElement("div");
          card.className = "order-card";
          card.innerHTML = `
            <div class="order-header">
              <div class="order-id">Order #${doc.id.slice(-8).toUpperCase()}</div>
              <div class="order-status ${getStatusClass(data.status)}">
                ${data.status || "Pending"}
              </div>
            </div>
            <div class="order-body">
              ${itemsHtml || '<p style="color:#777;text-align:center;padding:20px;">No items</p>'}
            </div>
            <div class="order-summary">
              <div class="summary-row">
                <span>Order Date</span>
                <span>${orderDate}</span>
              </div>
              <div class="summary-row">
                <span>Payment</span>
                <span>${data.paymentMethod || "Online"}</span>
              </div>
              <div class="summary-row total-row">
                <span>Total</span>
                <span>₹${(data.totalAmount || 0).toLocaleString()}</span>
              </div>
            </div>
          `;

          list.appendChild(card);
        });

        lastDoc = snap.docs[snap.docs.length - 1];
      } catch (err) {
        console.error(err);
        loading.innerHTML = "Error loading orders. Pull down to retry.";
      } finally {
        isLoading = false;
      }
    }

    auth.onAuthStateChanged(user => {
      if (!user) return location.href = "login.html";
      loadMoreOrders();
    });

    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const page = item.getAttribute('data-page');
        if (page === 'home') location.href = 'home.html';
        if (page === 'explore') location.href = 'explore.html';
      });
    });
  </script>
</body>
</html>